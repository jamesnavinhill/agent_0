# MEDIA GENERATION

Last reviewed: 2026-02-05 (local)

This document describes the image and video pipelines implemented in `lib/agent/tools/media.ts`, `lib/api/imagen.ts`, and `lib/api/veo.ts`.

## Image Generation

### Entry Points

- Task execution via `performDailyArt` (used by "Meaningful Media").
- API route `POST /api/generate/image` for direct image generation.

### Defaults (from code)

- Model: `gemini-2.5-flash-image`.
- Aspect ratio: `9:16`.
- Images are uploaded to local storage under `public/generated` and persisted to the gallery table.

### Prompt Construction

- If a task prompt is provided, it is used as-is.
- Otherwise, the system summarizes recent memories and asks the model to visualize the state.
- If memory context is minimal, a default "genesis" prompt is used.

### Image Storage

- Images are saved via `uploadGeneratedImage` to `public/generated`.
- Gallery rows store a local URL in `gallery_items.blob_url`.

## Image Editing

`editGalleryImage` creates a new image by combining the original image context with an edit prompt. It does not call a dedicated image-editing endpoint; it generates a new image based on prompt text and then saves it to the gallery as a new item.

## Video Generation (Veo)

### Modes

- `text-to-video`: prompt-only.
- `image-to-video`: animates a source image.

### Video Defaults (from code)

- Model: `veo-3.0-fast-generate-001`.
- Aspect ratio: `16:9`.
- Resolution: `1080p`.
- Duration: `6` seconds.
- Include audio: `false` (experimental; we send `includeAudio=false` in the Veo config).

### Source Image Selection (image-to-video)

- If `sourceGalleryId` is provided, that gallery item is used.
- Otherwise, the latest `image` in the `art` category is used.
- If none are found, the latest image in `public/generated` is used as a filesystem fallback.
- If metadata includes `aspectRatio`, it overrides the task aspect ratio.

### Storage

- Videos are generated by Veo, downloaded via the SDK, and saved to `public/generated`.
- Gallery rows store the local URL in `gallery_items.blob_url` with metadata including mode, aspect ratio, and duration.

## Settings Overrides

- Manual task runs can override task parameters via `/api/agent/execute`.
- The Settings panel stores image and video settings in localStorage and can sync those values to the task records using `PUT /api/tasks`.
- UI settings are applied as overrides for manual runs via the scheduler executor.

## Model Lists in Code

- Imagen/Gemini image models: `lib/api/imagen.ts`.
- Veo video models: `lib/api/veo.ts`.
- Chat models: `lib/api/gemini.ts` and `lib/api/models.ts`.
